During the Cantina competition, two researchers reported a Low risk vulnerability in the EVK code (Issue 3.1.28 of the Cantina Competition Report). They correctly identified that liquidation fails when a nested vault of the liability vault is used as collateral. This occurs due to re-entrancy when the liability vault attempts to price a nested vault. Since the `liquidate` function acquires the reentrancy lock, when the liability vault calls the `getQuote` function on the oracle router (which calls the non-reentrant `convertToAssets` function to recursively resolve the nested vault asset's price), the call reverts and prevents liquidation.

To address this issue, we implemented a fix by adding the `getQuote` function call to the oracle router whenever the new liquidation LTV being set is greater than zero (Fix 141 of the Cantina Competition Fixes Report). Combined with the non-reentrant `setLTV` function, this call was intended to ensure the vault could price all collaterals without causing re-entrancy, effectively preventing the use of nested liability vault as collateral. However, several months of production usage have revealed significant operational challenges with this solution.

A major issue was observed regarding vault configuration when using pull-based oracles. These oracles require active price updates from consumers, and reading prices fails without such updates. Consequently, before setting the LTV, vault governors must ensure the oracle is updated with a signed message from a trusted off-chain provider. This requirement forces governors to rely on complex and potentially unreliable scripts or UIs to batch LTV settings with oracle updates.

In practice, some governors have adopted a workaround: temporarily configuring the oracle router with a non-reverting stub oracle adapter, changing the LTV, then restoring the original oracle adapter. This approach has proven particularly useful for foundry-based deployment scripts (where fetching oracle update data is challenging) and for vaults governed by multisigs or timelocks (where price updates would become stale before transaction execution). However, this workaround introduces potential risks – improper, non-atomic implementation could lead to insolvency or unnecessary liquidations in existing vaults because the stub oracle returns different prices than the original oracle adapter.

Furthermore, the requirement for up-to-date prices complicates emergency responses. When governors need to quickly disable a collateral due to risk concerns by setting its borrow LTV to zero and keeping the liquidation LTV unchanged, the operation might fail due to stale oracle prices. This forces governors to either use the risky workaround described above or coordinate emergency actions with oracle updates – a challenging task during high-stress situations.

Given these considerations, we propose removing the `getQuote` function call from the `setLTV` function. This change would simplify vault configuration with pull-based oracles, eliminate the need for dangerous workarounds, and enable smooth emergency responses. We believe the original code change introduced to address Issue 3.1.28 of the Cantina Competition has proven too disruptive relative to its benefits. The low-severity issue can be better addressed through documentation updates rather than maintaining code that introduces operational complexity and potential risks.

As of time of writing, this change will only affect new EVK deployments. Existing EVK deployments (Ethereum Mainnet and Base) will stay the same. It will be further evaluated and discussed in the future whether the existing deployments should be upgraded to the new implementation considering the overall low severity of the issue.
